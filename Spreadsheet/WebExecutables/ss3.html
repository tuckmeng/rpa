<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Spreadsheet</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        table {
            border-collapse: collapse;
            margin: 20px 0;
        }
        td, th {
            border: 1px solid #ccc;
            padding: 10px;
            width: 100px;
            text-align: center;
        }
        button {
            margin: 10px;
            padding: 10px;
            cursor: pointer;
        }
    </style>
    <script src="zip-full.min.js"></script>
</head>
<body>

<h1>Simple Spreadsheet</h1>

<label for="numRows">Number of Rows:</label>
<input type="number" id="numRows" value="5" min="1">
<label for="numCols">Number of Columns:</label>
<input type="number" id="numCols" value="5" min="1">
<button onclick="createTable()">Create Table</button>

<table id="spreadsheet">
    <tbody>
        <!-- Table rows will be generated here -->
    </tbody>
</table>

<button onclick="saveData()">Save as XLSX</button>

<script>
// Using zip library in https://github.com/gildas-lormeau/zip.js/blob/master/dist/zip-full.min.js , save it to your local file
function translateColumn(number) {
    if (number < 1) {
        return null; // or throw an error if preferred
    }

    let columnName = '';

    while (number > 0) {
        number--;
        let remainder = number % 26;
        columnName = String.fromCharCode(65 + remainder) + columnName;
        number = Math.floor(number / 26);
    }

    return columnName;
}
</script>

<script>
    function createTable() {
        const numRows = parseInt(document.getElementById('numRows').value);
        const numCols = parseInt(document.getElementById('numCols').value);
        const tableBody = document.getElementById('spreadsheet').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = ''; // Clear existing table

        for (let i = 0; i < numRows; i++) {
            const row = tableBody.insertRow();
            for (let j = 0; j < numCols; j++) {
                const cell = row.insertCell();
                const input = document.createElement('input');
                input.type = 'text';
                input.style.width = '100%';
                cell.appendChild(input);
            }
        }
    }

    async function saveData() {
        const zipWriter = new zip.ZipWriter(new zip.BlobWriter("application/zip"));
        const sheetData = getData();

        // Create [Content_Types].xml
        const contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
        <Types xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
            <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
            <Default Extension="xml" ContentType="application/xml"/>
            <Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main"/>
            <Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
            <Override PartName="/xl/sharedStrings.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml"/>
            <Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml"/>
            <Override PartName="/xl/theme/theme1.xml" ContentType="application/vnd.openxmlformats-officedocument.theme+xml"/>
            <Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>
            <Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-officedocument.metadata.core+xml"/>
        </Types>`;

        // Create workbook.xml
        const workbook = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
        <workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
            <sheets>
                <sheet name="Sheet1" sheetId="1" r:id="rId1"/>
            </sheets>
            <calcPr calcId="0" fullCalcOnLoad="1"/>
        </workbook>`;

        // Create worksheet.xml
        const worksheet = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
        <worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
            <dimension ref="A1:` + translateColumn(document.getElementById('numCols').value) +  document.getElementById('numRows').value + `" />
            <sheetViews>
                <sheetView tabSelected="1" workbookViewId="0"/>
            </sheetViews>
            <sheetFormatPr defaultRowHeight="15"/>
            <sheetData>${createSheetData(sheetData)}</sheetData>
            <pageMargins left="0.7" right="0.7" top="0.75" bottom="0.75" header="0.3" footer="0.3"/>
        </worksheet>`;

        // Create sharedStrings.xml
        const uniqueStrings = getUniqueStrings(sheetData);
        const sharedStrings = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
        <sst xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" count="${uniqueStrings.length}" uniqueCount="${uniqueStrings.length}">
            ${uniqueStrings.map(str => `<si><t>${str}</t></si>`).join('')}
        </sst>`;

        // Create styles.xml
        const styles = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
        <styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
            <cellXfs>
                <xf numFmtId="0" fontId="0" fillId="0" borderId="0" xfId="0"/>
            </cellXfs>
            <fonts>
                <font>
                    <sz val="11"/>
                    <color theme="1"/>
                    <name val="Calibri"/>
                    <family val="2"/>
                    <scheme val="minor"/>
                </font>
            </fonts>
            <fills count="2">
                <fill>
                    <patternFill patternType="none"/>
                </fill>
                <fill>
                    <patternFill patternType="gray125"/>
                </fill>
            </fills>
            <borders count="1">
                <border>
                    <left/>
                    <right/>
                    <top/>
                    <bottom/>
                    <diagonal/>
                </border>
            </borders>
            <cellStyleXfs count="1">
                <xf numFmtId="0" fontId="0" fillId="0" borderId="0"/>
            </cellStyleXfs>
            <cellXfs count="1">
                <xf numFmtId="0" fontId="0" fillId="0" borderId="0" xfId="0"/>
            </cellXfs>
            <cellStyles count="1">
                <cellStyle name="Normal" xfId="0" builtinId="0"/>
            </cellStyles>
            <dxfs count="0"/>
            <tableStyles count="0" defaultTableStyle="TableStyleMedium9" defaultPivotStyle="PivotStyleLight16"/>
        </styleSheet>`;

        // Create _rels/.rels
        const rels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
        <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
            <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
        </Relationships>`;

        // Create theme1.xml
        const theme1 = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
        <a:theme xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main" name="Office">
            <a:objectDefaults>
                <a:clrScheme name="Office">
                    <a:dk1><a:srgbClr val="000000"/></a:dk1>
                    <a:lt1><a:srgbClr val="FFFFFF"/></a:lt1>
                    <a:dk2><a:srgbClr val="7F7F7F"/></a:dk2>
                    <a:lt2><a:srgbClr val="C0C0C0"/></a:lt2>
                </a:clrScheme>
            </a:objectDefaults>
        </a:theme>`;

        // Create docProps/core.xml
        const core = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
        <dc:coreProperties xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:dcmitype="http://purl.org/dc/dcmitype/" xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties">
            <dc:title>Simple Spreadsheet</dc:title>
            <dc:creator>Your Name</dc:creator>
            <dc:created xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dc:created>
            <dc:modified xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dc:modified>
        </dc:coreProperties>`;

        // Create docProps/app.xml
        const app = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
        <Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties">
            <Application>Microsoft Excel</Application>
            <DocSecurity>0</DocSecurity>
            <ScaleCrop>false</ScaleCrop>
            <HeadingPairs>
                <v:vector>
                    <v:entry>Title</v:entry>
                    <v:entry>Worksheet</v:entry>
                </v:vector>
            </HeadingPairs>
            <TitlesOfParts>
                <vt:vector size="1" baseType="lpstr">
                    <vt:lpstr>Sheet1</vt:lpstr>
                </vt:vector>
            </TitlesOfParts>
            <Company/>
            <LinksUpToDate>false</LinksUpToDate>
            <SharedDoc>false</SharedDoc>
            <HyperlinksChanged>false</HyperlinksChanged>
            <AppVersion>12.0000</AppVersion>
        </Properties>`;

        // Add files to the zip
        await zipWriter.add("[Content_Types].xml", new zip.TextReader(contentTypes));
        await zipWriter.add("_rels/.rels", new zip.TextReader(rels));
        await zipWriter.add("xl/workbook.xml", new zip.TextReader(workbook));
        await zipWriter.add("xl/worksheets/sheet1.xml", new zip.TextReader(worksheet));
        await zipWriter.add("xl/sharedStrings.xml", new zip.TextReader(sharedStrings));
        await zipWriter.add("xl/styles.xml", new zip.TextReader(styles));
        await zipWriter.add("xl/_rels/workbook.xml.rels", new zip.TextReader(rels));
        await zipWriter.add("xl/theme/theme1.xml", new zip.TextReader(theme1));
        await zipWriter.add("docProps/core.xml", new zip.TextReader(core));
        await zipWriter.add("docProps/app.xml", new zip.TextReader(app));

        // Finalize the zip file and download it
        const blob = await zipWriter.close();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'spreadsheet.xlsx';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function getData() {
        const table = document.getElementById('spreadsheet');
        const data = [];
        for (let row of table.rows) {
            const rowData = [];
            for (let cell of row.cells) {
                const input = cell.querySelector('input');
                rowData.push(input.value);
            }
            data.push(rowData);
        }
        return data;
    }

    function createSheetData(data) {
        const uniqueStrings = getUniqueStrings(data);
        return data.map((row, rowIndex) => {
            return `<row r="${rowIndex + 1}" spans="1:${document.getElementById('numCols').value}">` +
                row.map((cell, colIndex) => {
                    const cellValue = cell ? getSharedStringIndex(cell, uniqueStrings) : '';
                    return `<c r="${getCellReference(colIndex, rowIndex)}" t="s"><v>${cellValue}</v></c>`;
                }).join('') +
                `</row>`;
        }).join('');
    }

    function getCellReference(colIndex, rowIndex) {
        const letters = [];
        while (colIndex >= 0) {
            letters.unshift(String.fromCharCode((colIndex % 26) + 65));
            colIndex = Math.floor(colIndex / 26) - 1;
        }
        return letters.join('') + (rowIndex + 1); // row index starts from 1
    }

    function getUniqueStrings(data) {
        const uniqueStrings = new Set();
        data.forEach(row => {
            row.forEach(cell => {
                if (cell) uniqueStrings.add(cell);
            });
        });
        return Array.from(uniqueStrings);
    }

    function getSharedStringIndex(value, uniqueStrings) {
        const index = uniqueStrings.indexOf(value);
        return index !== -1 ? index : 0; // default to 0 if not found
    }

</script>

</body>
</html>
